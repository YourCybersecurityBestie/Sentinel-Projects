# Defender for Servers Plan 2: Daily Billable Ingestion & Cost Savings Analysis

KQL queries for Microsoft Sentinel / Log Analytics that calculate daily billable ingestion, actual savings, and cost after the **Microsoft Defender for Servers Plan 2** benefit (500 MB/server/day).

---

## Table of Contents

- [Overview](#overview)
- [The Defender for Servers P2 Benefit](#the-defender-for-servers-p2-benefit)
  - [How It Works](#how-it-works)
  - [Eligible Tables](#eligible-tables)
  - [Where the Benefit Is Recorded](#where-the-benefit-is-recorded)
- [Query Architecture](#query-architecture)
  - [Configuration Variables](#configuration-variables)
  - [Part A-1: Per-Table Daily Ingestion](#part-a-1-per-table-daily-ingestion)
  - [Part A-2: Daily Rollup](#part-a-2-daily-rollup)
  - [Part B: Daily Benefit Applied](#part-b-daily-benefit-applied)
  - [Part C: Join & Calculate](#part-c-join--calculate)
- [Queries](#queries)
  - [Daily Cost & Savings Query](#daily-cost--savings-query)
  - [Period Summary Query](#period-summary-query)
- [Output Reference](#output-reference)
  - [Daily Query Columns](#daily-query-columns)
  - [Period Summary Columns](#period-summary-columns)
  - [Example Scenario](#example-scenario)
- [Why Run at the Log Analytics Layer](#why-run-at-the-log-analytics-layer)
- [Configuration & Considerations](#configuration--considerations)
  - [PricePerGB](#pricepergb)
  - [LookbackDays & Table Retention](#lookbackdays--table-retention)
  - [Eligible Tables List](#eligible-tables-list)
  - [BenefitType Filter](#benefittype-filter)
  - [When BenefitAppliedGB Shows Zero](#when-benefitappliedgb-shows-zero)
- [Operational Recommendations](#operational-recommendations)
- [References](#references)
- [License](#license)

---

## Overview

Microsoft Defender for Servers Plan 2 provides a data ingestion benefit of **500 MB per server per day** for a defined set of security-related Log Analytics tables. When this benefit is active, it significantly reduces or eliminates the cost of ingesting security telemetry into your Log Analytics workspace and, by extension, Microsoft Sentinel.

This repository contains two compound KQL queries designed to run directly in the **Log Analytics query editor**:

| Query | Purpose |
|-------|---------|
| **Daily Cost & Savings** | One row per day showing eligible ingestion, benefit applied, billable cost, savings, and per-table breakdown |
| **Period Summary** | One row for the entire lookback window with totals, averages, and benefit-active day counts |

These queries answer three questions that arise frequently in cost-governance reviews and FinOps reporting:

1. **How much security data are we ingesting daily** from the tables that qualify for the P2 benefit?
2. **How much is Microsoft actually covering** through the benefit, and how much remains billable?
3. **What is the estimated monetary saving per day**, and what would the cost be without the benefit?

---

## The Defender for Servers P2 Benefit

### How It Works

Each server covered by Defender for Servers Plan 2 contributes a **500 MB/day allowance**. These allowances are **pooled** across all servers reporting to the same Log Analytics workspace and applied as a **single daily deduction**.

**Example:** An organisation with 40 servers receives a pooled benefit of **20 GB/day**.
- If eligible ingestion that day is **15 GB** → the entire amount is covered at **zero cost**
- If eligible ingestion that day is **25 GB** → the first 20 GB is free, the remaining **5 GB is billed**

### Eligible Tables

Only data landing in these specific tables counts toward (and is covered by) the benefit:

| Table Name | Description |
|------------|-------------|
| `SecurityEvent` | Windows Security Events (Event IDs 4624, 4625, 4688, etc.) |
| `WindowsFirewall` | Windows Firewall log events |
| `SecurityAlert` | Alerts generated by Defender for Cloud |
| `SecurityBaseline` | OS security baseline assessment results |
| `SecurityBaselineSummary` | Aggregated baseline assessment summaries |
| `SecurityDetection` | Security detections from Defender |
| `ProtectionStatus` | Endpoint protection / antimalware status |
| `Update` | Windows Update assessment data |
| `UpdateSummary` | Summary of update compliance |
| `MDCFileIntegrityMonitoringEvents` | File Integrity Monitoring (FIM) change events |
| `LinuxAuditLog` | Linux auditd log events |

> **Important:** Any table not listed above (e.g. `Syslog`, `CommonSecurityLog`, custom tables) does **not** qualify for the P2 benefit and is billed at the standard rate regardless of Defender for Servers status.

### Where the Benefit Is Recorded

Microsoft records the daily benefit amount in the **`Operation` table** within the Log Analytics workspace. Each day, a row is written with:

- **`Detail`** column: `"Benefit amount used: X.XXX GB"`
- **`OperationKey`** column: `"Benefit type used: Standard Data Included per Node"`

This tracking began on **27 January 2024**. The queries read these rows to determine the exact GB amount Microsoft deducted for each day.

---

## Query Architecture

Both queries follow the same three-part compound structure using `let` bindings to create named intermediate result sets, joined in a final tabular expression. This design avoids nested-aggregation errors in the Log Analytics KQL engine.

### Configuration Variables

Set these at the top of each query before running:

| Variable | Default | Purpose |
|----------|---------|---------|
| `LookbackDays` | `30` | Number of days of history to analyse. Do not exceed the retention period of the `Usage` or `Operation` tables. |
| `PricePerGB` | `2.00` | Your effective cost per GB. For Sentinel simplified pricing, this is a single combined rate. For classic pricing, sum the LA ingestion rate + Sentinel analysis rate. Adjust for commitment tier / EA discounts. |

### Part A-1: Per-Table Daily Ingestion

Queries the **`Usage`** table (a system table in every Log Analytics workspace) filtered to `IsBillable == true` and the eleven eligible `DataType` values. The `Quantity` column is in **megabytes**, so the query divides by 1,000 for GB. Output: one row per `Day` per `DataType` with `DailyGB`.

### Part A-2: Daily Rollup

Rolls up the per-table output into **one row per Day**. Sums `DailyGB` across all eligible tables to produce `EligibleIngestionGB`, and builds a JSON `TableBreakdown` showing per-table contributions.

> **Why two steps?** Combining `sum()` and `make_bag(bag_pack(...))` in a single `summarize` causes the KQL error *"Function sum cannot be invoked in current context"*. Splitting into two `let` blocks materialises the intermediate result and avoids this.

### Part B: Daily Benefit Applied

Queries the **`Operation`** table for rows where `Detail startswith "Benefit amount used"`. Uses the `parse` operator to extract the numeric GB value and the benefit type string. Filters to the Defender for Servers benefit only (excluding the separate M365 E5 Sentinel benefit if present).

### Part C: Join & Calculate

Performs a `leftouter` join between the daily ingestion and daily benefit on the `Day` column. Left-outer ensures days with no benefit row still appear (with `BenefitAppliedGB` defaulting to 0 via `coalesce`). Computes billable GB, cost, savings, and the hypothetical cost without the benefit.

---

## Queries

### Daily Cost & Savings Query

> **File:** [`defender_p2_daily_FIXED_classic_pricing.kql`](defender_p2_daily_FIXED_classic_pricing.kql)

```kql
// ============================================================================
// Defender for Servers P2 — Daily Cost & Savings (Classic Pricing Edition)
// (Author: Venicia Solomons)
// ============================================================================
// For environments on CLASSIC pricing (separate LA + Sentinel tiers).
// Uses separate rate variables because each benefit offsets a different meter.
//
// CHANGE LOG:
//   - BenefitType filter: "contains" instead of "has" (fixes MicrosoftDefender match)
//   - Two rate variables: one for LA (Defender benefit), one for Sentinel (M365 benefit)
//   - Both benefits shown in separate columns
//   - BenefitActive column shows ✅/❌ for quick visual check
//
// HOW TO FIND YOUR RATES:
//   Go to Sentinel > Settings > Pricing tab.
//   LA rate  = LA tier daily cost ÷ tier GB  (e.g. $799.18 ÷ 400 = $2.00)
//   Sentinel rate = Sentinel tier daily cost ÷ tier GB (e.g. $892.32 ÷ 1000 = $0.89)
//
// CONFIGURATION:
let LookbackDays = 30;
let LAEffectiveRate = 2.00;       // Log Analytics effective $/GB from your commitment tier
let SentinelEffectiveRate = 0.89; // Sentinel effective $/GB from your commitment tier
let CombinedRate = 2.89;          // LA + Sentinel combined (for CostWithoutBenefit column)
let EligibleTables = dynamic([
    "SecurityEvent",
    "WindowsFirewall",
    "SecurityAlert",
    "SecurityBaseline",
    "SecurityBaselineSummary",
    "SecurityDetection",
    "ProtectionStatus",
    "Update",
    "UpdateSummary",
    "MDCFileIntegrityMonitoringEvents",
    "LinuxAuditLog"
]);
// -- Part A-1: Per-table daily ingestion in GB ---------------------------
let PerTableDaily =
    Usage
    | where TimeGenerated >= ago(1d * LookbackDays)
    | where IsBillable == true
    | where DataType in (EligibleTables)
    | summarize DailyMB = sum(Quantity) by Day = startofday(TimeGenerated), DataType
    | extend DailyGB = round(DailyMB / 1000.0, 3);
// -- Part A-2: Roll up to one row per Day --------------------------------
let DailyEligibleIngestion =
    PerTableDaily
    | summarize
        EligibleIngestionGB = round(sum(DailyGB), 3),
        TableBreakdown      = make_bag(bag_pack(tostring(DataType), DailyGB))
        by Day;
// -- Part B-1: Defender for Servers P2 benefit ---------------------------
// Offsets the LA ingestion charge under classic pricing
let DailyDefenderBenefit =
    Operation
    | where TimeGenerated >= ago(1d * LookbackDays)
    | where Detail startswith "Benefit amount used"
    | parse Detail with "Benefit amount used: " BenefitGB_str " GB"
    | extend BenefitGB = toreal(BenefitGB_str)
    | parse OperationKey with "Benefit type used: " BenefitType
    | where BenefitType contains "MicrosoftDefender" or BenefitType contains "Node" or BenefitType contains "Standard" or BenefitType contains "Defender"
    | summarize DefenderBenefitGB = round(sum(BenefitGB), 3) by Day = startofday(TimeGenerated);
// -- Part B-2: Microsoft 365 E5 Sentinel benefit ------------------------
// Offsets the Sentinel analysis charge under classic pricing
let DailySentinelBenefit =
    Operation
    | where TimeGenerated >= ago(1d * LookbackDays)
    | where Detail startswith "Benefit amount used"
    | parse Detail with "Benefit amount used: " BenefitGB_str " GB"
    | extend BenefitGB = toreal(BenefitGB_str)
    | parse OperationKey with "Benefit type used: " BenefitType
    | where BenefitType contains "Sentinel" or BenefitType contains "M365"
    | summarize SentinelM365BenefitGB = round(sum(BenefitGB), 3) by Day = startofday(TimeGenerated);
// -- Part C: Join and calculate ------------------------------------------
DailyEligibleIngestion
| join kind=leftouter DailyDefenderBenefit on Day
| join kind=leftouter DailySentinelBenefit on Day
| extend
    DefenderBenefitGB       = coalesce(DefenderBenefitGB, 0.0),
    SentinelM365BenefitGB   = coalesce(SentinelM365BenefitGB, 0.0)
| extend
    // Quick visual check: is the Defender benefit active?
    BenefitActive           = iff(DefenderBenefitGB > 0, "✅ Yes", "❌ No"),
    // Savings: each benefit uses its own rate under classic pricing
    DefenderSavings         = round(DefenderBenefitGB * LAEffectiveRate, 2),
    SentinelM365Savings     = round(SentinelM365BenefitGB * SentinelEffectiveRate, 2),
    TotalDailySavings       = round((DefenderBenefitGB * LAEffectiveRate) + (SentinelM365BenefitGB * SentinelEffectiveRate), 2),
    // Billable: eligible ingestion minus the Defender benefit (LA portion only)
    // Note: The M365 Sentinel benefit applies to ALL data, not just eligible tables,
    // so it is shown as a saving but not subtracted from eligible ingestion here.
    BillableGB              = round(max_of(0.0, EligibleIngestionGB - DefenderBenefitGB), 3),
    BillableLACost          = round(max_of(0.0, EligibleIngestionGB - DefenderBenefitGB) * LAEffectiveRate, 2),
    CostWithoutAnyBenefit   = round(EligibleIngestionGB * CombinedRate, 2)
| project
    Day,
    EligibleIngestionGB,
    BenefitActive,
    DefenderBenefitGB,
    DefenderSavings,
    TotalDailySavings,
    BillableGB,
    BillableLACost,
    CostWithoutAnyBenefit,
    TableBreakdown
| sort by Day desc
```

### Period Summary Query

> **File:** [`defender_p2_period_summary_classic_pricing.kql`](defender_p2_period_summary_classic_pricing.kql)

```kql
// ============================================================================
// Defender for Servers P2 — PERIOD SUMMARY (Classic Pricing Edition)
// (Author: Venicia Solomons)
// ============================================================================
// One summary row for the entire lookback window showing totals:
//   Defender P2 savings, M365 E5 Sentinel savings, billable cost,
//   and what cost would have been without any benefits.
//
// HOW TO FIND YOUR RATES:
//   Go to Sentinel > Settings > Pricing tab.
//   LA rate  = LA tier daily cost ÷ tier GB  (e.g. $799.18 ÷ 400 = $2.00)
//   Sentinel rate = Sentinel tier daily cost ÷ tier GB (e.g. $892.32 ÷ 1000 = $0.89)
//
// CONFIGURATION:
let LookbackDays = 30;
let LAEffectiveRate = 2.00;       // Log Analytics effective $/GB from your commitment tier
let SentinelEffectiveRate = 0.89; // Sentinel effective $/GB from your commitment tier
let CombinedRate = 2.89;          // LA + Sentinel combined (for CostWithoutBenefit column)
let EligibleTables = dynamic([
    "SecurityEvent",
    "WindowsFirewall",
    "SecurityAlert",
    "SecurityBaseline",
    "SecurityBaselineSummary",
    "SecurityDetection",
    "ProtectionStatus",
    "Update",
    "UpdateSummary",
    "MDCFileIntegrityMonitoringEvents",
    "LinuxAuditLog"
]);
// -- Part A-1: Per-table daily ingestion in GB ---------------------------
let PerTableDaily =
    Usage
    | where TimeGenerated >= ago(1d * LookbackDays)
    | where IsBillable == true
    | where DataType in (EligibleTables)
    | summarize DailyMB = sum(Quantity) by Day = startofday(TimeGenerated), DataType
    | extend DailyGB = round(DailyMB / 1000.0, 3);
// -- Part A-2: Roll up to one row per Day --------------------------------
let DailyEligibleIngestion =
    PerTableDaily
    | summarize EligibleIngestionGB = round(sum(DailyGB), 3) by Day;
// -- Part B-1: Defender for Servers P2 benefit ---------------------------
let DailyDefenderBenefit =
    Operation
    | where TimeGenerated >= ago(1d * LookbackDays)
    | where Detail startswith "Benefit amount used"
    | parse Detail with "Benefit amount used: " BenefitGB_str " GB"
    | extend BenefitGB = toreal(BenefitGB_str)
    | parse OperationKey with "Benefit type used: " BenefitType
    | where BenefitType contains "MicrosoftDefender" or BenefitType contains "Node" or BenefitType contains "Standard" or BenefitType contains "Defender"
    | summarize DefenderBenefitGB = round(sum(BenefitGB), 3) by Day = startofday(TimeGenerated);
// -- Part B-2: Microsoft 365 E5 Sentinel benefit ------------------------
let DailySentinelBenefit =
    Operation
    | where TimeGenerated >= ago(1d * LookbackDays)
    | where Detail startswith "Benefit amount used"
    | parse Detail with "Benefit amount used: " BenefitGB_str " GB"
    | extend BenefitGB = toreal(BenefitGB_str)
    | parse OperationKey with "Benefit type used: " BenefitType
    | where BenefitType contains "Sentinel" or BenefitType contains "M365"
    | summarize SentinelM365BenefitGB = round(sum(BenefitGB), 3) by Day = startofday(TimeGenerated);
// -- Part C: Join, calculate daily, then summarise the period ------------
DailyEligibleIngestion
| join kind=leftouter DailyDefenderBenefit on Day
| join kind=leftouter DailySentinelBenefit on Day
| extend
    DefenderBenefitGB     = coalesce(DefenderBenefitGB, 0.0),
    SentinelM365BenefitGB = coalesce(SentinelM365BenefitGB, 0.0),
    BillableGB            = max_of(0.0, EligibleIngestionGB - coalesce(DefenderBenefitGB, 0.0))
| summarize
    PeriodDays                  = dcount(Day),
    TotalEligibleGB             = round(sum(EligibleIngestionGB), 2),
    TotalDefenderBenefitGB      = round(sum(DefenderBenefitGB), 2),
    TotalDefenderSavings        = round(sum(DefenderBenefitGB) * LAEffectiveRate, 2),
    TotalSentinelM365BenefitGB  = round(sum(SentinelM365BenefitGB), 2),
    TotalSentinelM365Savings    = round(sum(SentinelM365BenefitGB) * SentinelEffectiveRate, 2),
    TotalCombinedSavings        = round((sum(DefenderBenefitGB) * LAEffectiveRate) + (sum(SentinelM365BenefitGB) * SentinelEffectiveRate), 2),
    TotalBillableGB             = round(sum(BillableGB), 2),
    TotalBillableLACost         = round(sum(BillableGB) * LAEffectiveRate, 2),
    CostWithoutAnyBenefit       = round(sum(EligibleIngestionGB) * CombinedRate, 2),
    AvgDailyIngestionGB         = round(avg(EligibleIngestionGB), 3),
    AvgDailyDefenderSavings     = round(avg(DefenderBenefitGB) * LAEffectiveRate, 2),
    AvgDailyTotalSavings        = round((avg(DefenderBenefitGB) * LAEffectiveRate) + (avg(SentinelM365BenefitGB) * SentinelEffectiveRate), 2),
    AvgDailyBillableLACost      = round(avg(BillableGB) * LAEffectiveRate, 2),
    DaysBenefitActive           = countif(DefenderBenefitGB > 0),
    DaysBenefitInactive         = countif(DefenderBenefitGB == 0)
```

---

## Output Reference

### Daily Query Columns

| Column | Description |
|--------|-------------|
| `Day` | Calendar date (UTC). |
| `EligibleIngestionGB` | Total GB ingested that day from all P2-eligible tables (SecurityEvent, WindowsFirewall, SecurityBaseline, etc.). |
| `BenefitActive` | Quick visual indicator: **✅ Yes** if the Defender P2 benefit was applied that day, **❌ No** if it was not. The most recent day (today) will typically show ❌ No because the Operation table benefit row has not been written yet — this is normal. |
| `DefenderBenefitGB` | The GB that Microsoft actually deducted under the Defender for Servers P2 benefit. Under classic pricing, this offsets the **Log Analytics ingestion charge only**, not the Sentinel analysis charge. |
| `DefenderSavings` | The dollar value saved by the Defender benefit that day (`DefenderBenefitGB × LAEffectiveRate`). |
| `SentinelM365BenefitGB` | The GB covered by the Microsoft 365 E5/A5/F5/G5 Sentinel benefit (if applicable). This is a separate benefit from a different licence that offsets the **Sentinel analysis charge** under classic pricing. Not all environments will have this. |
| `SentinelM365Savings` | The dollar value saved by the M365 Sentinel benefit that day (`SentinelM365BenefitGB × SentinelEffectiveRate`). |
| `TotalDailySavings` | Combined savings from both the Defender P2 benefit and the M365 Sentinel benefit. |
| `BillableGB` | The remaining eligible GB after the Defender benefit is subtracted — this is what you are still billed for on the LA side. If the benefit covers your entire eligible ingestion, this will be **0**. |
| `BillableLACost` | The estimated Log Analytics cost for the billable remainder (`BillableGB × LAEffectiveRate`). |
| `CostWithoutAnyBenefit` | What the day's eligible ingestion would cost if no benefits existed at all (`EligibleIngestionGB × CombinedRate`). This column demonstrates the total financial value of your licences. |
| `TableBreakdown` | JSON object showing per-table GB contribution (e.g. `{"SecurityEvent": 0.005, "ProtectionStatus": 0.001}`). Useful for identifying which tables drive the most volume. |

### Period Summary Columns

| Column | Description |
|--------|-------------|
| `PeriodDays` | Number of days in the analysis window. |
| `TotalEligibleGB` | Total GB ingested from eligible tables across the period. |
| `TotalBenefitAppliedGB` | Total GB covered by the P2 benefit. |
| `TotalSavingsAmount` | Total dollar savings from the benefit. |
| `TotalBillableGB` | Total GB billed after the benefit. |
| `TotalBillableCost` | Total dollar cost for billable data. |
| `CostWithoutBenefit` | What the period would have cost without P2. |
| `AvgDailyIngestionGB` | Average daily eligible ingestion. |
| `AvgDailySavings` | Average daily dollar savings. |
| `AvgDailyBillableCost` | Average daily billable cost. |
| `DaysBenefitActive` | Days where the benefit was applied (> 0 GB). |
| `DaysBenefitInactive` | Days where the benefit was not applied. |

### Reading the Output — Real-World Example

Below is an example of actual output from a small environment. This shows how the query results look when the Defender P2 benefit is active and fully covering the eligible ingestion:

| Day | EligibleIngestionGB | BenefitActive | DefenderBenefitGB | DefenderSavings | TotalDailySavings | BillableGB | BillableLACost | CostWithoutAnyBenefit |
|-----|--------------------:|:-------------:|------------------:|----------------:|------------------:|-----------:|---------------:|----------------------:|
| 13/02/2026 | 0.001 | ❌ No | 0 | 0 | 0 | 0.001 | 0 | 0 |
| 12/02/2026 | 0.005 | ✅ Yes | 0.005 | 0.01 | 0.01 | 0 | 0 | 0.01 |
| 11/02/2026 | 0.005 | ✅ Yes | 0.005 | 0.01 | 0.01 | 0 | 0 | 0.01 |
| 10/02/2026 | 0.005 | ✅ Yes | 0.005 | 0.01 | 0.01 | 0 | 0 | 0.01 |
| 09/02/2026 | 0.007 | ✅ Yes | 0.007 | 0.01 | 0.01 | 0 | 0 | 0.02 |
| 08/02/2026 | 0.006 | ✅ Yes | 0.006 | 0.01 | 0.01 | 0 | 0 | 0.02 |
| 07/02/2026 | 0.006 | ✅ Yes | 0.006 | 0.01 | 0.01 | 0 | 0 | 0.02 |
| 06/02/2026 | 0.006 | ✅ Yes | 0.006 | 0.01 | 0.01 | 0 | 0 | 0.02 |
| 05/02/2026 | 0.006 | ✅ Yes | 0.006 | 0.01 | 0.01 | 0 | 0 | 0.02 |
| 04/02/2026 | 0.007 | ✅ Yes | 0.007 | 0.01 | 0.01 | 0 | 0 | 0.02 |
| 03/02/2026 | 0.003 | ❌ No | 0 | 0 | 0 | 0.003 | 0.01 | 0.01 |

**What this tells us:**

- **The benefit is active and working.** All days show ✅ Yes except 13 Feb (the current day — the benefit row hasn't been written yet, this is normal) and 3 Feb (where the benefit was not recorded for that day, so the 0.003 GB fell through as billable).
- **Eligible ingestion is very low** (~5–7 MB/day). This is well below the 500 MB/server/day allowance, so the benefit covers the entire amount with `BillableGB = 0` and `BillableLACost = 0` on active days.
- **`CostWithoutAnyBenefit`** shows what each day would cost without any licence benefits — even though the amounts are small here ($0.01–$0.02/day), in larger environments this column can show hundreds or thousands of dollars per day, making the value of the P2 licence clearly visible.
- **The `TableBreakdown` column** (not shown in the table above for readability, but visible in the query output) shows the per-table GB split, making it easy to see which tables drive ingestion.

> **Note on the ❌ No rows:** The most recent day will almost always show ❌ No because Microsoft writes the benefit row to the Operation table at the end of the billing day. If you see ❌ No on **older** days, that may indicate a genuine gap in benefit coverage worth investigating.

### Scaling to Larger Environments

In a larger environment with **400+ servers** and **200+ GB/day** of eligible ingestion, the same output would show `DefenderBenefitGB` values of 170–210 GB, `DefenderSavings` of $340–$420/day, and `BillableGB` representing only the portion exceeding the pooled benefit. The `CostWithoutAnyBenefit` column would show $600–$900/day, making the ROI of the P2 licence immediately clear to finance stakeholders.

---

## Why Run at the Log Analytics Layer

These queries must be executed directly against the **Log Analytics workspace**, not through Sentinel's hunting interface or Azure Cost Management. The reasons are:

**The `Usage` and `Operation` tables live in Log Analytics.** The `Usage` table is a system table maintained by the workspace that records per-table ingestion volume. The `Operation` table is where Microsoft records the benefit-applied events. Both are most reliably queried from the Log Analytics Logs blade.

**Daily ingestion granularity.** Azure Cost Management provides monthly billing aggregates, but the P2 benefit is applied daily. To track whether the benefit is fully utilised, partially utilised, or not applied, daily granularity is essential.

**Per-table visibility.** Cost Management shows aggregate costs by meter but does not break down ingestion by individual table name. The `Usage` table's `DataType` column provides this, which is critical for identifying volume drivers and tuning DCRs.

**Benefit verification.** The `Operation` table is the **only** place where you can see the exact GB Microsoft deducted each day. This is not visible in Sentinel cost workbooks or Cost Management meter breakdowns.

---

## Configuration & Considerations

### Pricing Configuration

The query uses separate rate variables because the benefits offset different billing meters. How you set them depends on your pricing model:

#### Classic Pricing (separate LA + Sentinel tiers)

Under classic pricing, Log Analytics ingestion and Sentinel analysis are billed separately. The Defender P2 benefit only offsets the LA charge; the M365 E5 benefit only offsets the Sentinel charge.

To find your rates, go to **Sentinel → Settings → Pricing tab**. The commitment tier panels show the daily cost and GB for each:

| Variable | How to Calculate | Example |
|----------|-----------------|---------|
| `LAEffectiveRate` | LA tier daily cost ÷ tier GB | $799.18 ÷ 400 = **$2.00/GB** |
| `SentinelEffectiveRate` | Sentinel tier daily cost ÷ tier GB | $892.32 ÷ 1,000 = **$0.89/GB** |
| `CombinedRate` | LA + Sentinel rates added together | $2.00 + $0.89 = **$2.89/GB** |

#### Simplified Pricing (single combined tier)

Under simplified pricing, LA and Sentinel are merged into one rate. The P2 benefit applies to the **full combined rate**, which increases the dollar value of the benefit. Use one rate for all three variables, or set `LAEffectiveRate` and `SentinelEffectiveRate` to the same combined rate.

To find the rate: **Sentinel → Settings → Pricing tab** → your commitment tier shows one daily cost and GB. Divide to get the effective rate.

#### Pay-As-You-Go

If not on a commitment tier, check the [Azure pricing page](https://azure.microsoft.com/pricing/details/microsoft-sentinel/) for your region's PAYG rate.

### LookbackDays & Table Retention

Default: `30`. Do not set this higher than the interactive retention period of your `Usage` and `Operation` tables (typically 90 days by default). The `Operation` table benefit tracking started **27 January 2024** — historical data before that date will not contain benefit rows.

> **Tip:** Increase the `Operation` table retention to 180 or 365 days for long-term trend analysis.

### Eligible Tables List

The `EligibleTables` array reflects the current [Microsoft documentation](https://learn.microsoft.com/azure/defender-for-cloud/data-ingestion-benefit). If Microsoft adds or removes tables, update the array. Review the documentation at least quarterly.

### BenefitType Filter

The Part B filter uses `contains` to match the Defender benefit type in the `OperationKey` column. Different environments may label the benefit differently — known values include `MicrosoftDefender`, `Standard Data Included per Node`, and variations. Using `contains "Defender"` instead of `has "Defender"` ensures single-token labels like `MicrosoftDefender` (no spaces) are matched correctly.

The `Operation` table may also contain rows for the **Microsoft 365 E5/A5/F5/G5 Sentinel benefit** (labelled `SentinelMicrosoft365`). The classic pricing query separates the two benefits into distinct columns. If you only have the P2 benefit and not the M365 licence, the `SentinelM365BenefitGB` column will simply show 0.

> **Tip:** Run this query to see all benefit types present in your workspace:
> ```kql
> Operation
> | where TimeGenerated >= ago(31d)
> | where Detail startswith "Benefit amount used"
> | parse OperationKey with "Benefit type used: " BenefitType
> | distinct BenefitType
> ```

### When BenefitAppliedGB Shows Zero

If `BenefitAppliedGB` is consistently zero, the benefit is not being applied. Common causes:

- **P2 not enabled on the workspace** — it may be enabled at the subscription level only, which is not sufficient. Enable it directly on the workspace via Defender for Cloud → Environment settings.
- **Security solution not installed** on the workspace — this is a prerequisite.
- **Servers reporting to a different workspace** — the benefit is granted to the workspace where the machine reports.
- **Servers not running AMA** — the Azure Monitor Agent is required since the retirement of the legacy Log Analytics agent (MMA).

---

## Operational Recommendations

1. **Schedule a recurring run.** Save the query as a Log Analytics function and create a scheduled Workbook or analytics rule that runs it daily/weekly for continuous visibility.

2. **Alert on benefit loss.** Create a log search alert that triggers when `BenefitAppliedGB` drops to zero for two or more consecutive days to detect unintentional deactivation before it impacts your bill.

3. **Tune SecurityEvent collection.** If `SecurityEvent` dominates eligible ingestion (typical), review your Data Collection Rules to collect only the Event IDs required by your detection rules and compliance. Filtering at the DCR level reduces data before it reaches the workspace.

4. **Increase Operation table retention.** Extending to 180 or 365 days enables quarterly and annual trend analysis for budget reviews.

5. **Review eligible tables periodically.** Check the [official documentation](https://learn.microsoft.com/azure/defender-for-cloud/data-ingestion-benefit) at least quarterly and update `EligibleTables` if it changes.

---

## References

- [Use the data ingestion benefit in Microsoft Defender for Cloud](https://learn.microsoft.com/azure/defender-for-cloud/data-ingestion-benefit)
- [Azure Monitor cost and usage](https://learn.microsoft.com/azure/azure-monitor/cost-usage)
- [Analyze usage in a Log Analytics workspace](https://learn.microsoft.com/azure/azure-monitor/logs/analyze-usage)
- [Plan costs and understand Microsoft Sentinel pricing and billing](https://learn.microsoft.com/azure/sentinel/billing)
- [Common questions — Defender for Servers](https://learn.microsoft.com/azure/defender-for-cloud/faq-defender-for-servers)
- [Azure Monitor Logs cost calculations and options](https://learn.microsoft.com/azure/azure-monitor/logs/cost-logs)

---

## License

This project is provided under development and not an official Microsoft created project with no affilication to official Microsoft created resources and documentation. 
