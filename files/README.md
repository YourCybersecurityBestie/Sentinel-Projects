# Defender for Servers Plan 2 — Daily Billable Ingestion & Cost Savings Analysis
Author: Venicia Solomons, Solution Engineer - Cloud and AI Security, Microsoft
KQL queries for Microsoft Sentinel / Log Analytics that calculate daily billable ingestion, actual savings, and cost after the **Microsoft Defender for Servers Plan 2** benefit (500 MB/server/day).

---

## Table of Contents

- [Overview](#overview)
- [The Defender for Servers P2 Benefit](#the-defender-for-servers-p2-benefit)
  - [How It Works](#how-it-works)
  - [Eligible Tables](#eligible-tables)
  - [Where the Benefit Is Recorded](#where-the-benefit-is-recorded)
- [Query Architecture](#query-architecture)
  - [Configuration Variables](#configuration-variables)
  - [Part A-1: Per-Table Daily Ingestion](#part-a-1-per-table-daily-ingestion)
  - [Part A-2: Daily Rollup](#part-a-2-daily-rollup)
  - [Part B: Daily Benefit Applied](#part-b-daily-benefit-applied)
  - [Part C: Join & Calculate](#part-c-join--calculate)
- [Queries](#queries)
  - [Daily Cost & Savings Query](#daily-cost--savings-query)
  - [Period Summary Query](#period-summary-query)
- [Output Reference](#output-reference)
  - [Daily Query Columns](#daily-query-columns)
  - [Period Summary Columns](#period-summary-columns)
  - [Example Scenario](#example-scenario)
- [Why Run at the Log Analytics Layer](#why-run-at-the-log-analytics-layer)
- [Configuration & Considerations](#configuration--considerations)
  - [PricePerGB](#pricepergb)
  - [LookbackDays & Table Retention](#lookbackdays--table-retention)
  - [Eligible Tables List](#eligible-tables-list)
  - [BenefitType Filter](#benefittype-filter)
  - [When BenefitAppliedGB Shows Zero](#when-benefitappliedgb-shows-zero)
- [Operational Recommendations](#operational-recommendations)
- [References](#references)
- [License](#license)

---

## Overview

Microsoft Defender for Servers Plan 2 provides a data ingestion benefit of **500 MB per server per day** for a defined set of security-related Log Analytics tables. When this benefit is active, it significantly reduces or eliminates the cost of ingesting security telemetry into your Log Analytics workspace and, by extension, Microsoft Sentinel.

This repository contains two compound KQL queries designed to run directly in the **Log Analytics query editor**:

| Query | Purpose |
|-------|---------|
| **Daily Cost & Savings** | One row per day showing eligible ingestion, benefit applied, billable cost, savings, and per-table breakdown |
| **Period Summary** | One row for the entire lookback window with totals, averages, and benefit-active day counts |

These queries answer three questions that arise frequently in cost-governance reviews and FinOps reporting:

1. **How much security data are we ingesting daily** from the tables that qualify for the P2 benefit?
2. **How much is Microsoft actually covering** through the benefit, and how much remains billable?
3. **What is the estimated monetary saving per day**, and what would the cost be without the benefit?

---

## The Defender for Servers P2 Benefit

### How It Works

Each server covered by Defender for Servers Plan 2 contributes a **500 MB/day allowance**. These allowances are **pooled** across all servers reporting to the same Log Analytics workspace and applied as a **single daily deduction**.

**Example:** An organisation with 40 servers receives a pooled benefit of **20 GB/day**.
- If eligible ingestion that day is **15 GB** → the entire amount is covered at **zero cost**
- If eligible ingestion that day is **25 GB** → the first 20 GB is free, the remaining **5 GB is billed**

### Eligible Tables

Only data landing in these specific tables counts toward (and is covered by) the benefit:

| Table Name | Description |
|------------|-------------|
| `SecurityEvent` | Windows Security Events (Event IDs 4624, 4625, 4688, etc.) |
| `WindowsFirewall` | Windows Firewall log events |
| `SecurityAlert` | Alerts generated by Defender for Cloud |
| `SecurityBaseline` | OS security baseline assessment results |
| `SecurityBaselineSummary` | Aggregated baseline assessment summaries |
| `SecurityDetection` | Security detections from Defender |
| `ProtectionStatus` | Endpoint protection / antimalware status |
| `Update` | Windows Update assessment data |
| `UpdateSummary` | Summary of update compliance |
| `MDCFileIntegrityMonitoringEvents` | File Integrity Monitoring (FIM) change events |
| `LinuxAuditLog` | Linux auditd log events |

> **Important:** Any table not listed above (e.g. `Syslog`, `CommonSecurityLog`, custom tables) does **not** qualify for the P2 benefit and is billed at the standard rate regardless of Defender for Servers status.

### Where the Benefit Is Recorded

Microsoft records the daily benefit amount in the **`Operation` table** within the Log Analytics workspace. Each day, a row is written with:

- **`Detail`** column: `"Benefit amount used: X.XXX GB"`
- **`OperationKey`** column: `"Benefit type used: Standard Data Included per Node"`

This tracking began on **27 January 2024**. The queries read these rows to determine the exact GB amount Microsoft deducted for each day.

---

## Query Architecture

Both queries follow the same three-part compound structure using `let` bindings to create named intermediate result sets, joined in a final tabular expression. This design avoids nested-aggregation errors in the Log Analytics KQL engine.

### Configuration Variables

Set these at the top of each query before running:

| Variable | Default | Purpose |
|----------|---------|---------|
| `LookbackDays` | `30` | Number of days of history to analyse. Do not exceed the retention period of the `Usage` or `Operation` tables. |
| `PricePerGB` | `2.76` | Your effective cost per GB. For Sentinel simplified pricing, this is a single combined rate. For classic pricing, sum the LA ingestion rate + Sentinel analysis rate. Adjust for commitment tier / EA discounts. |

### Part A-1: Per-Table Daily Ingestion

Queries the **`Usage`** table (a system table in every Log Analytics workspace) filtered to `IsBillable == true` and the eleven eligible `DataType` values. The `Quantity` column is in **megabytes**, so the query divides by 1,000 for GB. Output: one row per `Day` per `DataType` with `DailyGB`.

### Part A-2: Daily Rollup

Rolls up the per-table output into **one row per Day**. Sums `DailyGB` across all eligible tables to produce `EligibleIngestionGB`, and builds a JSON `TableBreakdown` showing per-table contributions.

> **Why two steps?** Combining `sum()` and `make_bag(bag_pack(...))` in a single `summarize` causes the KQL error *"Function sum cannot be invoked in current context"*. Splitting into two `let` blocks materialises the intermediate result and avoids this.

### Part B: Daily Benefit Applied

Queries the **`Operation`** table for rows where `Detail startswith "Benefit amount used"`. Uses the `parse` operator to extract the numeric GB value and the benefit type string. Filters to the Defender for Servers benefit only (excluding the separate M365 E5 Sentinel benefit if present).

### Part C: Join & Calculate

Performs a `leftouter` join between the daily ingestion and daily benefit on the `Day` column. Left-outer ensures days with no benefit row still appear (with `BenefitAppliedGB` defaulting to 0 via `coalesce`). Computes billable GB, cost, savings, and the hypothetical cost without the benefit.

---

## Queries

### Daily Cost & Savings Query

> **File:** [`queries/defender_p2_daily_with_savings.kql`](queries/defender_p2_daily_with_savings.kql)

```kql
let LookbackDays = 30;
let PricePerGB = 2.76;
let EligibleTables = dynamic([
    "SecurityEvent",
    "WindowsFirewall",
    "SecurityAlert",
    "SecurityBaseline",
    "SecurityBaselineSummary",
    "SecurityDetection",
    "ProtectionStatus",
    "Update",
    "UpdateSummary",
    "MDCFileIntegrityMonitoringEvents",
    "LinuxAuditLog"
]);
let PerTableDaily =
    Usage
    | where TimeGenerated >= ago(1d * LookbackDays)
    | where IsBillable == true
    | where DataType in (EligibleTables)
    | summarize DailyMB = sum(Quantity) by Day = startofday(TimeGenerated), DataType
    | extend DailyGB = round(DailyMB / 1000.0, 3);
let DailyEligibleIngestion =
    PerTableDaily
    | summarize
        EligibleIngestionGB = round(sum(DailyGB), 3),
        TableBreakdown      = make_bag(bag_pack(tostring(DataType), DailyGB))
        by Day;
let DailyBenefitUsed =
    Operation
    | where TimeGenerated >= ago(1d * LookbackDays)
    | where Detail startswith "Benefit amount used"
    | parse Detail with "Benefit amount used: " BenefitUsedGB_str " GB"
    | extend BenefitUsedGB = toreal(BenefitUsedGB_str)
    | parse OperationKey with "Benefit type used: " BenefitType
    | where BenefitType has "Node" or BenefitType has "Defender" or BenefitType has "Standard"
    | summarize BenefitUsedGB = round(sum(BenefitUsedGB), 3) by Day = startofday(TimeGenerated);
DailyEligibleIngestion
| join kind=leftouter DailyBenefitUsed on Day
| extend
    BenefitAppliedGB     = coalesce(BenefitUsedGB, 0.0),
    DailySavingsGB       = coalesce(BenefitUsedGB, 0.0),
    DailySavingsAmount   = round(coalesce(BenefitUsedGB, 0.0) * PricePerGB, 2),
    BillableGB           = round(max_of(0.0, EligibleIngestionGB - coalesce(BenefitUsedGB, 0.0)), 3),
    BillableCost         = round(max_of(0.0, EligibleIngestionGB - coalesce(BenefitUsedGB, 0.0)) * PricePerGB, 2),
    CostWithoutBenefit   = round(EligibleIngestionGB * PricePerGB, 2)
| project
    Day,
    EligibleIngestionGB,
    BenefitAppliedGB,
    DailySavingsAmount,
    BillableGB,
    BillableCost,
    CostWithoutBenefit,
    TableBreakdown
| sort by Day desc
```

### Period Summary Query

> **File:** [`queries/defender_p2_period_summary.kql`](queries/defender_p2_period_summary.kql)

```kql
let LookbackDays = 30;
let PricePerGB = 2.76;
let EligibleTables = dynamic([
    "SecurityEvent",
    "WindowsFirewall",
    "SecurityAlert",
    "SecurityBaseline",
    "SecurityBaselineSummary",
    "SecurityDetection",
    "ProtectionStatus",
    "Update",
    "UpdateSummary",
    "MDCFileIntegrityMonitoringEvents",
    "LinuxAuditLog"
]);
let PerTableDaily =
    Usage
    | where TimeGenerated >= ago(1d * LookbackDays)
    | where IsBillable == true
    | where DataType in (EligibleTables)
    | summarize DailyMB = sum(Quantity) by Day = startofday(TimeGenerated), DataType
    | extend DailyGB = round(DailyMB / 1000.0, 3);
let DailyEligibleIngestion =
    PerTableDaily
    | summarize EligibleIngestionGB = round(sum(DailyGB), 3) by Day;
let DailyBenefitUsed =
    Operation
    | where TimeGenerated >= ago(1d * LookbackDays)
    | where Detail startswith "Benefit amount used"
    | parse Detail with "Benefit amount used: " BenefitUsedGB_str " GB"
    | extend BenefitUsedGB = toreal(BenefitUsedGB_str)
    | parse OperationKey with "Benefit type used: " BenefitType
    | where BenefitType has "Node" or BenefitType has "Defender" or BenefitType has "Standard"
    | summarize BenefitUsedGB = round(sum(BenefitUsedGB), 3) by Day = startofday(TimeGenerated);
DailyEligibleIngestion
| join kind=leftouter DailyBenefitUsed on Day
| extend
    BenefitAppliedGB = coalesce(BenefitUsedGB, 0.0),
    BillableGB       = max_of(0.0, EligibleIngestionGB - coalesce(BenefitUsedGB, 0.0))
| summarize
    PeriodDays              = dcount(Day),
    TotalEligibleGB         = round(sum(EligibleIngestionGB), 2),
    TotalBenefitAppliedGB   = round(sum(BenefitAppliedGB), 2),
    TotalSavingsAmount      = round(sum(BenefitAppliedGB) * PricePerGB, 2),
    TotalBillableGB         = round(sum(BillableGB), 2),
    TotalBillableCost       = round(sum(BillableGB) * PricePerGB, 2),
    CostWithoutBenefit      = round(sum(EligibleIngestionGB) * PricePerGB, 2),
    AvgDailyIngestionGB     = round(avg(EligibleIngestionGB), 3),
    AvgDailySavings         = round(avg(BenefitAppliedGB) * PricePerGB, 2),
    AvgDailyBillableCost    = round(avg(BillableGB) * PricePerGB, 2),
    DaysBenefitActive       = countif(BenefitAppliedGB > 0),
    DaysBenefitInactive     = countif(BenefitAppliedGB == 0)
```

---

## Output Reference

### Daily Query Columns

| Column | Description |
|--------|-------------|
| `Day` | Calendar date (UTC) |
| `EligibleIngestionGB` | Total GB ingested from all P2-eligible tables that day |
| `BenefitAppliedGB` | GB Microsoft actually deducted as the P2 benefit |
| `DailySavingsAmount` | Dollar value saved by the benefit that day |
| `BillableGB` | GB remaining after benefit — this is what you pay for |
| `BillableCost` | Estimated cost for the billable GB |
| `CostWithoutBenefit` | What the full eligible ingestion would cost without P2 |
| `TableBreakdown` | JSON object showing per-table GB (e.g. `{"SecurityEvent": 0.27}`) |

### Period Summary Columns

| Column | Description |
|--------|-------------|
| `PeriodDays` | Number of days in the analysis window |
| `TotalEligibleGB` | Total GB ingested from eligible tables across the period |
| `TotalBenefitAppliedGB` | Total GB covered by the P2 benefit |
| `TotalSavingsAmount` | Total dollar savings from the benefit |
| `TotalBillableGB` | Total GB billed after the benefit |
| `TotalBillableCost` | Total dollar cost for billable data |
| `CostWithoutBenefit` | What the period would have cost without P2 |
| `AvgDailyIngestionGB` | Average daily eligible ingestion |
| `AvgDailySavings` | Average daily dollar savings |
| `AvgDailyBillableCost` | Average daily billable cost |
| `DaysBenefitActive` | Days where the benefit was applied (> 0 GB) |
| `DaysBenefitInactive` | Days where the benefit was not applied |

### Example Scenario

An organisation with **50 servers** (pooled benefit: **25 GB/day**) ingests **18 GB** of eligible data on a given day:

| Column | Value |
|--------|-------|
| `EligibleIngestionGB` | 18.000 |
| `BenefitAppliedGB` | 18.000 (entire amount covered) |
| `DailySavingsAmount` | $49.68 |
| `BillableGB` | 0.000 |
| `BillableCost` | $0.00 |
| `CostWithoutBenefit` | $49.68 |

Savings: **~$49.68/day → ~$1,490/month**. If ingestion spiked to 30 GB, the benefit would cap at 25 GB, leaving 5 GB billable ($13.80).

---

## Why Run at the Log Analytics Layer

These queries must be executed directly against the **Log Analytics workspace**, not through Sentinel's hunting interface or Azure Cost Management. The reasons are:

**The `Usage` and `Operation` tables live in Log Analytics.** The `Usage` table is a system table maintained by the workspace that records per-table ingestion volume. The `Operation` table is where Microsoft records the benefit-applied events. Both are most reliably queried from the Log Analytics Logs blade.

**Daily ingestion granularity.** Azure Cost Management provides monthly billing aggregates, but the P2 benefit is applied daily. To track whether the benefit is fully utilised, partially utilised, or not applied, daily granularity is essential.

**Per-table visibility.** Cost Management shows aggregate costs by meter but does not break down ingestion by individual table name. The `Usage` table's `DataType` column provides this, which is critical for identifying volume drivers and tuning DCRs.

**Benefit verification.** The `Operation` table is the **only** place where you can see the exact GB Microsoft deducted each day. This is not visible in Sentinel cost workbooks or Cost Management meter breakdowns.

---

## Configuration & Considerations

### PricePerGB

The default `2.76` is an example. Your actual rate depends on your pricing model:

- **Pay-As-You-Go** — check list price for your region
- **Commitment Tier** — effective rate shown in workspace Usage and Estimated Costs blade
- **Sentinel Simplified Pricing** — single combined rate for ingestion + analysis
- **Classic Pricing** — sum Log Analytics ingestion rate + Sentinel analysis rate
- **Enterprise Agreement** — negotiated discount applies

Navigate to **Log Analytics workspace → Usage and Estimated Costs** in the Azure portal to find your effective rate.

### LookbackDays & Table Retention

Default: `30`. Do not set this higher than the interactive retention period of your `Usage` and `Operation` tables (typically 90 days by default). The `Operation` table benefit tracking started **27 January 2024** — historical data before that date will not contain benefit rows.

> **Tip:** Increase the `Operation` table retention to 180 or 365 days for long-term trend analysis.

### Eligible Tables List

The `EligibleTables` array reflects the current [Microsoft documentation](https://learn.microsoft.com/azure/defender-for-cloud/data-ingestion-benefit). If Microsoft adds or removes tables, update the array. Review the documentation at least quarterly.

### BenefitType Filter

The Part B filter (`has "Node" or has "Defender" or has "Standard"`) isolates the Defender for Servers benefit. The `Operation` table may also contain rows for the **Microsoft 365 E5/A5/F5/G5 Sentinel benefit** with a different `OperationKey`. To include both benefits, remove the filter. To report them separately, group on `BenefitType`.

### When BenefitAppliedGB Shows Zero

If `BenefitAppliedGB` is consistently zero, the benefit is not being applied. Common causes:

- **P2 not enabled on the workspace** — it may be enabled at the subscription level only, which is not sufficient. Enable it directly on the workspace via Defender for Cloud → Environment settings.
- **Security solution not installed** on the workspace — this is a prerequisite.
- **Servers reporting to a different workspace** — the benefit is granted to the workspace where the machine reports.
- **Servers not running AMA** — the Azure Monitor Agent is required since the retirement of the legacy Log Analytics agent (MMA).

---

## Operational Recommendations

1. **Schedule a recurring run.** Save the query as a Log Analytics function and create a scheduled Workbook or analytics rule that runs it daily/weekly for continuous visibility.

2. **Alert on benefit loss.** Create a log search alert that triggers when `BenefitAppliedGB` drops to zero for two or more consecutive days to detect unintentional deactivation before it impacts your bill.

3. **Tune SecurityEvent collection.** If `SecurityEvent` dominates eligible ingestion (typical), review your Data Collection Rules to collect only the Event IDs required by your detection rules and compliance. Filtering at the DCR level reduces data before it reaches the workspace.

4. **Increase Operation table retention.** Extending to 180 or 365 days enables quarterly and annual trend analysis for budget reviews.

5. **Review eligible tables periodically.** Check the [official documentation](https://learn.microsoft.com/azure/defender-for-cloud/data-ingestion-benefit) at least quarterly and update `EligibleTables` if it changes.

---

## References

- [Use the data ingestion benefit in Microsoft Defender for Cloud](https://learn.microsoft.com/azure/defender-for-cloud/data-ingestion-benefit)
- [Azure Monitor cost and usage](https://learn.microsoft.com/azure/azure-monitor/cost-usage)
- [Analyze usage in a Log Analytics workspace](https://learn.microsoft.com/azure/azure-monitor/logs/analyze-usage)
- [Plan costs and understand Microsoft Sentinel pricing and billing](https://learn.microsoft.com/azure/sentinel/billing)
- [Common questions — Defender for Servers](https://learn.microsoft.com/azure/defender-for-cloud/faq-defender-for-servers)
- [Azure Monitor Logs cost calculations and options](https://learn.microsoft.com/azure/azure-monitor/logs/cost-logs)

---

## License

This project is provided under the [MIT License](LICENSE).
